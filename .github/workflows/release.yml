name: Flutter Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      target_platform:
        description: 'Target platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - windows
          - linux
          - macos
          - ios
          - web

env:
  FLUTTER_VERSION: '3.38.9'
  DART_VERSION: '3.10.8'

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: android
            os: ubuntu-latest
            build_cmd: flutter build apk --release && flutter build appbundle --release
            artifact_path: build/app/outputs/
            artifact_name: android
          - target: windows
            os: windows-latest
            build_cmd: flutter build windows --release
            artifact_path: build/windows/installer/
            artifact_name: windows
          - target: linux
            os: ubuntu-latest
            build_cmd: flutter build linux --release
            artifact_path: build/linux/*/release/bundle/
            artifact_name: linux
          - target: macos
            os: macos-latest
            build_cmd: flutter build macos --release
            artifact_path: build/macos/Build/Products/Release/
            artifact_name: macos
          - target: ios
            os: macos-latest
            build_cmd: flutter build ios --release --no-codesign
            artifact_path: build/ios/iphoneos/
            artifact_name: ios
          - target: web
            os: ubuntu-latest
            build_cmd: flutter build web
            artifact_path: build/web/
            artifact_name: web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Setup Java (for Android)
        if: matrix.target == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Decode and Validate Keystore (Android)
        if: matrix.target == 'android'
        env:
          KEYSTORE_BASE64: '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'
        run: |
          set -euo pipefail
          if [ -z "$KEYSTORE_BASE64" ]; then
            echo "Error: KEYSTORE_BASE64 secret is not set."
            exit 1
          fi
          mkdir -p android/app/sign
          echo "$KEYSTORE_BASE64" | base64 --decode > android/app/sign/prompt_optimization.jks
          
          # Verify keystore
          if [ ! -s android/app/sign/prompt_optimization.jks ]; then
            echo "Error: Keystore file is empty after decoding."
            exit 1
          fi
          keytool -list -keystore android/app/sign/prompt_optimization.jks -storepass 'prompt_optimization' -v 2>&1 | head -20

      - name: Create key.properties (Android)
        if: matrix.target == 'android'
        env:
          KEYSTORE_PASSWORD: 'prompt_optimization'
          KEY_PASSWORD: 'prompt_optimization'
          KEY_ALIAS: 'prompt_optimization'
        run: |
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=sign/prompt_optimization.jks
          EOF

      - name: Install Linux dependencies
        if: matrix.target == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build ${{ matrix.target }}
        run: ${{ matrix.build_cmd }}

      - name: Install Inno Setup (Windows)
        if: matrix.target == 'windows'
        run: |
          choco install innosetup -y
          $env:PATH += ";C:\Program Files (x86)\Inno Setup 6"
          [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")

      - name: Create Inno Setup installer (Windows)
        if: matrix.target == 'windows'
        run: |
          $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:').Line.Split(' ')[1].Split('+')[0]
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /DMyAppVersion=$VERSION windows\installer.iss

      - name: Upload ${{ matrix.target }} artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-build
          path: ${{ matrix.artifact_path }}
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-assets/android-build/**/*.apk
            release-assets/android-build/**/*.aab
            release-assets/windows-build/**/*.exe
            release-assets/linux-build/**
            release-assets/macos-build/**/*.app
            release-assets/ios-build/**/*.app
            release-assets/web-build/**
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Prompt Optimizer ${{ github.ref_name }}
            
            ### 下载链接
            - **Android APK**: 适用于直接安装
            - **Android AAB**: 适用于 Google Play 发布
            - **Windows**: Windows 安装包 (.exe),双击即可安装
            - **Linux**: Linux 桌面应用
            - **macOS**: macOS 桌面应用
            - **iOS**: iOS 应用(需要签名)
            - **Web**: 在线版本
            
            ### 新特性
            请查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) 了解详细更新内容。
            
            ### 使用说明
            详细使用说明请参考 [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
