name: Build & Release Prompt Optimizer

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/*.png'
      - '**/*.jpg'
      - 'LICENSE'
      - '.gitignore'

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•ï¼ˆä»…å¯¹åˆ†æ”¯æ¨é€å’ŒPRè¿è¡Œï¼‰
  test:
    name: Code Quality & Tests
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Check code formatting
        run: dart format --set-exit-if-changed .
        
      - name: Analyze code
        run: flutter analyze
        
      - name: Run tests
        run: flutter test

  # Android æ„å»º
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      # é…ç½® Android ç­¾åï¼ˆä»…åœ¨æ­£å¼å‘å¸ƒæ—¶ï¼‰
      - name: Setup Android signing (Release only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p android/app/sign
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/sign/prompt_optimization.jks
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        
      # æ„å»ºä¸åŒç±»å‹çš„åŒ…
      - name: Build APK (Debug for branches, Release for tags)
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # æ­£å¼å‘å¸ƒç‰ˆæœ¬
            flutter build apk --release --target-platform=android-arm64,android-x64
            flutter build appbundle --release
          else
            # æµ‹è¯•ç‰ˆæœ¬
            flutter build apk --debug
          fi
          
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            build/app/outputs/flutter-apk/app-*.apk
          retention-days: 30
          
      - name: Upload AAB Artifact (Release only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-*.aab
          retention-days: 30

  # Windows æ„å»º
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Build Windows
        run: flutter build windows --release
        
      - name: Package Windows
        run: |
          cd build\windows\x64\runner\Release
          Compress-Archive -Path * -DestinationPath ..\..\..\..\prompt-optimizer-windows.zip
          
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: prompt-optimizer-windows.zip
          retention-days: 30

  # Linux æ„å»º
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Build Linux
        run: flutter build linux --release
        
      - name: Package Linux
        run: |
          cd build/linux/x64/release/bundle
          tar -czvf ../../../../prompt-optimizer-linux.tar.gz *
          
      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-app
          path: prompt-optimizer-linux.tar.gz
          retention-days: 30

  # macOS æ„å»º
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Build macOS
        run: flutter build macos --release
        
      - name: Package macOS
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../prompt-optimizer-macos.zip Prompt\ Optimizer.app
          
      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: prompt-optimizer-macos.zip
          retention-days: 30

  # Web æ„å»º
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: Install dependencies
        run: flutter pub get
        
      - name: Generate files (Drift database)
        run: dart run build_runner build --delete-conflicting-outputs
        
      - name: Build Web
        run: flutter build web --release
        
      - name: Package Web
        run: |
          cd build/web
          tar -czvf ../../prompt-optimizer-web.tar.gz *
          
      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-app
          path: prompt-optimizer-web.tar.gz
          retention-days: 30

  # åˆ›å»º GitHub Releaseï¼ˆä»…åœ¨ Tag æ¨é€æ—¶ï¼‰
  release:
    name: Create GitHub Release
    needs: [build-android, build-windows, build-linux, build-macos, build-web]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Prepare Release Files
        run: |
          mkdir release_files
          
          # Android
          cp artifacts/android-apk/app-*.apk release_files/prompt-optimizer-android.apk || true
          cp artifacts/android-aab/app-*.aab release_files/prompt-optimizer-android.aab || true
          
          # Desktop
          cp artifacts/windows-app/prompt-optimizer-windows.zip release_files/ || true
          cp artifacts/macos-app/prompt-optimizer-macos.zip release_files/ || true
          cp artifacts/linux-app/prompt-optimizer-linux.tar.gz release_files/ || true
          
          # Web
          cp artifacts/web-app/prompt-optimizer-web.tar.gz release_files/ || true
          
          # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶
          ls -la release_files/
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Prompt Optimizer ${{ github.ref_name }}
          body: |
            ## ğŸš€ Prompt Optimizer ${{ github.ref_name }}
            
            ### ğŸ“± ä¸‹è½½è¯´æ˜
            - **Android APK**: ç›´æ¥å®‰è£…çš„å®‰å“åº”ç”¨åŒ…
            - **Android AAB**: Google Play å‘å¸ƒåŒ…ï¼ˆæ¨èç”¨äºå•†åº—å‘å¸ƒï¼‰
            - **Windows**: Windows æ¡Œé¢åº”ç”¨ï¼ˆè§£å‹å³ç”¨ï¼‰
            - **macOS**: macOS åº”ç”¨ï¼ˆæ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹ï¼‰
            - **Linux**: Linux åº”ç”¨ï¼ˆè§£å‹åè¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼‰
            - **Web**: Web åº”ç”¨ï¼ˆå¯éƒ¨ç½²åˆ°ä»»ä½• Web æœåŠ¡å™¨ï¼‰
            
            ### âœ¨ æ–°ç‰¹æ€§
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/JIULANG9/PromptOptimizer/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
            
            ### ğŸ”§ ç³»ç»Ÿè¦æ±‚
            - Android 5.0+ (API 21+)
            - Windows 10+ (x64)
            - macOS 10.14+ (x64)
            - Linux (GLIBC 2.17+)
            - ç°ä»£æµè§ˆå™¨ï¼ˆæ”¯æŒ WebAssemblyï¼‰
            
            ### ğŸ“„ è®¸å¯è¯
            æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](https://github.com/JIULANG9/PromptOptimizer/blob/main/LICENSE) æ–‡ä»¶ã€‚
          files: release_files/*
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
