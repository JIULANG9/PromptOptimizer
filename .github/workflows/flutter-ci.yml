name: Flutter CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: '3.38.9'  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
  DART_VERSION: '3.10.8'  # ä¸é¡¹ç›®è¦æ±‚ ^3.10.3 å…¼å®¹
  JAVA_VERSION: '17'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

  # ==========================================
  # Android å¤šæ¶æ„æ„å»º
  # ==========================================
  build_android:
    name: Build Android ${{ matrix.arch }}
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    strategy:
      matrix:
        include:
          - arch: arm64-v8a
            target: android-arm64
            output_name: android-arm64v8
          - arch: armeabi-v7a
            target: android-arm
            output_name: android-arm32v7
          - arch: x86_64
            target: android-x64
            output_name: android-x64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Build APK (${{ matrix.arch }})
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            flutter build apk --debug --target-platform ${{ matrix.target }}
          else
            flutter build apk --release --target-platform ${{ matrix.target }}
          fi

      - name: Rename APK with version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SOURCE="build/app/outputs/flutter-apk/app-debug.apk"
          else
            SOURCE="build/app/outputs/flutter-apk/app-release.apk"
          fi
          cp "$SOURCE" "prompt-optimizer-${VERSION}-${{ matrix.output_name }}.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.output_name }}
          path: prompt-optimizer-*.apk
          retention-days: 30

  # Android AAB (Google Play å‘å¸ƒ)
  build_android_aab:
    name: Build Android AAB (Google Play)
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Decode Keystore
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks

      - name: Create key.properties
        if: github.event_name != 'pull_request'
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: |
          echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "storeFile=upload-keystore.jks" >> android/key.properties

      - name: Build AAB (App Bundle)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            flutter build appbundle --debug
          else
            flutter build appbundle --release
          fi

      - name: Rename AAB with version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SOURCE="build/app/outputs/bundle/debug/app-debug.aab"
          else
            SOURCE="build/app/outputs/bundle/release/app-release.aab"
          fi
          cp "$SOURCE" "prompt-optimizer-${VERSION}-android-google-play.aab"

      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: android-google-play
          path: prompt-optimizer-*.aab
          retention-days: 30

  # ==========================================
  # Windows æ„å»º
  # ==========================================
  build_windows:
    name: Build Windows
    runs-on: windows-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Windows executable
        run: |
          if ('${{ github.event_name }}' -eq 'pull_request') {
            flutter build windows --debug
          } else {
            flutter build windows --release
          }

      - name: Package Windows
        run: |
          $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:').Line.Split(' ')[1].Split('+')[0]
          if ('${{ github.event_name }}' -eq 'pull_request') {
            $source = "build/windows/x64/runner/Debug"
          } else {
            $source = "build/windows/x64/runner/Release"
          }
          Compress-Archive -Path "$source\*" -DestinationPath "prompt-optimizer-$VERSION-windows-x86_64.zip" -Force

      - name: Upload Windows
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: prompt-optimizer-*.zip
          retention-days: 30

  # Linux æ„å»ºä»»åŠ¡
  build_linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Linux executable
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            flutter build linux --debug
          else
            flutter build linux --release
          fi

      - name: Package Linux
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SOURCE="build/linux/x64/debug/bundle"
          else
            SOURCE="build/linux/x64/release/bundle"
          fi
          tar -czf "prompt-optimizer-${VERSION}-linux-x86_64.tar.gz" -C "$SOURCE" .

      - name: Upload Linux
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: prompt-optimizer-*.tar.gz
          retention-days: 30

  # macOS æ„å»ºä»»åŠ¡
  build_macos:
    name: Build macOS
    runs-on: macos-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build macOS app
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            flutter build macos --debug
          else
            flutter build macos --release
          fi

      - name: Package macOS
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            SOURCE="build/macos/Build/Products/Debug"
          else
            SOURCE="build/macos/Build/Products/Release"
          fi
          cd "$SOURCE"
          zip -r "../../../prompt-optimizer-${VERSION}-macos-universal.zip" *.app

      - name: Upload macOS
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: prompt-optimizer-*.zip
          retention-days: 30

  # ==========================================
  # Web æ„å»º
  # ==========================================
  build_web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          dart-version: ${{ env.DART_VERSION }}
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Generate code
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build Web app
        run: flutter build web

      - name: Package Web
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          cd build/web
          zip -r "../../prompt-optimizer-${VERSION}-web.zip" .

      - name: Upload Web
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: prompt-optimizer-*.zip
          retention-days: 30


  # è‡ªåŠ¨åˆ›å»ºç‰ˆæœ¬ Tag å’Œ Release
  create_tag_and_release:
    name: Create Tag and Release
    runs-on: ubuntu-latest
    needs: [build_android, build_android_aab, build_windows, build_linux, build_macos, build_web]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG does not exist"
          fi

      - name: Download all artifacts
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        if: steps.check_tag.outputs.exists == 'false'
        run: ls -la artifacts/

      - name: Create Tag
        if: steps.check_tag.outputs.exists == 'false'
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.get_version.outputs.version }}"
          name: "Prompt Optimizer v${{ steps.get_version.outputs.version }}"
          files: artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ğŸš€ Prompt Optimizer v${{ steps.get_version.outputs.version }}

            ### ğŸ“± ä¸‹è½½é“¾æ¥

            **Android:**
            - `prompt-optimizer-*-android-arm64v8.apk` - ARM64 è®¾å¤‡ï¼ˆæ¨èï¼‰
            - `prompt-optimizer-*-android-arm32v7.apk` - ARM32 è®¾å¤‡
            - `prompt-optimizer-*-android-x64.apk` - x86_64 æ¨¡æ‹Ÿå™¨/è®¾å¤‡
            - `prompt-optimizer-*-android-google-play.aab` - Google Play å‘å¸ƒ

            **Windows:**
            - `prompt-optimizer-*-windows-x86_64.zip` - Windows ä¾¿æºç‰ˆ

            **Linux:**
            - `prompt-optimizer-*-linux-x86_64.tar.gz` - Linux ä¾¿æºç‰ˆ

            **macOS:**
            - `prompt-optimizer-*-macos-universal.zip` - macOS åº”ç”¨

            **Web:**
            - `prompt-optimizer-*-web.zip` - Web éƒ¨ç½²æ–‡ä»¶

            ### âœ¨ æ–°ç‰¹æ€§
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

            ### ğŸ“– ä½¿ç”¨è¯´æ˜
            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

